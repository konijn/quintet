<html>
  <head>
    <!--  -->
    <title>Mevarick</title>
    <style>
      body {background-color:black; color:white; white-space:pre; font-family:monospace; text-align:center }
      
    </style>
  </head>
  <body>
  <div id="screen"></div>
</body>

<script>
//2d map helpers
map2 = 
{
  apply : function( f )
  {
    for( var y = 0 ; y < this.map2.y ; y++ )
      for( var x = 0 ; x < this.map2.x ; x++ )
        f( this[x][y] , this );
  },
  applyRow : function( y , f )
  {
    for( var x = 0 ; x < this.map2.x ; x++ )
      f( [x][y] , this );
  },    
  applyColumn : function( x , f )
  {
    for( var y = 0 ; x < this.map2.y ; y++ )
      f( this[x][y] , this );
  },        
  applyBag : function( bag , f )
  {
     var cursor = this.cursor || { x : 0 , y : 0 };
     for( var i = 0 ; i < bag.length ; i++ )
     {
       cursor.x = bag[i].x || cursor.x;
       cursor.y = bag[i].y || cursor.y;         
       f( this[cursor.x][cursor.y] , bag[i] , this , bag  );
     }
  },    
  init : function( o, config ,f )
  {
    o.map2 = config;
    for( var x = 0 ; x < o.map2.x ; x++ )
      if( o[x] = [] ) //I might burn for this :P
        for( var y = 0 ; y < o.map2.y ; y++ )
            f( o[x][y] = o[x][y] || { x : x , y : y } , x , y , o );
    for( key in map2 )
      o[key] = map2[key];
    return o;  
  },
  neighbours : function( cell , v/*ectors*/, f/*ilter*/ )
  {
    var set = [], maybe;
    for( var i = 0 ; i < v.length ; i++ )
      if( this[cell.x+v[i].x] )
        if( maybe = this[cell.x+v[i].x][cell.y+v[i].y] )
          if( !f || ( f && f( maybe ) ) )
            set.push( maybe );
    return set;    
  },
  allNeighbours: [ {x:0,y:-1},{x:0,y:1},{x:1,y:-1},{x:1,y:1},{x:1,y:0},{x:-1,y:-1},{x:-1,y:1},{x:-1,y:0} ],
  cardinalNeighbours : [{x:0,y:-1},{x:0,y:1},{x:1,y:0},{x:-1,y:0}]
}
    
function createCursor(parent,x,y,cursor)
{
  y = y || 0; x = x || 0,
  cursor = {
    parent : parent,
    color : cursor,
    x : x,
    y : y,
    advance : function()
    {
      this.x++;
      if( this.x == this.parent.w )
      {
        this.x = 0;
        this.y++;
        if( this.y == this.parent.h )
          this.y = 0;  
      }
    }
  }
  return cursor;
}    
    
    
//The screen  
screen = 
{
  h : 25, //h is height
  w : 80, //w is width
  cursor  : false, 
  div : document.getElementById("screen"),
  initialize : function()
  {
    map2.init( this , {  x : this.w , y : this.h } , function(c,x,y,o)
    { 
      c.char = 'o' , c.color = 'green' , c.eol = (x==o.map2.x-1) 
    });
    this.cursor = createCursor(this,0,0,false);
    console.log( "Hello World" );
    return this;
  },
  clear: function()
  {
    this.apply( function(c){ c.char = '&nbsp;' } );
    return this;
  },
  print: function( s , color )
  {
     var oldColor = this.cursor.color;
     if(color) 
       this.cursor.color = color;

     this.applyBag( s.split("") , function( c , entry, o )
     {
       c.color = o.cursor.color || c.color;
       c.char = entry;  
       o.cursor.advance();
     });
     
     if(color) 
       this.cursor.color = oldColor;     
     return this;
  },
  write : function()
  {
    this.html = '';
    this.apply( function(c,o)
    { 
      o.html = o.html + c.char + (c.eol?"<br>":"") 
    });
    //console.log( this.html );
    this.div.innerHTML = this.html;
    return this;
  }
}.initialize().clear().print("Hello World").write();



//http://kuoi.com/~kamikaze/GameDesign/art07_rogue_dungeon.php
function dungeonGenerator( config )
{
  var grid = map2.init( { cells:[] } , { x:config.w , y:config.h } , function(c,x,y,o)
  { 
    c.connected = true;
  });
    
  grid.apply( function(cell,grid)
  {
    cell.neighbours = grid.neighbours( cell , grid.allNeighbours );
    grid.cells.push(cell);
  });

   console.log( grid.cells.shuffle() );
}

Array.prototype.shuffle = function()
{
  var out = [] , tmp = this , idx; 
  while( tmp.length )
  {
    out.push( tmp[idx = Math.floor(tmp.length * Math.random())] );
    tmp = tmp.slice( idx , idx + 1 );                   
  }
  return out;  
}

dungeonGenerator( { w:3 , h:3 } );
  
</script>
</html>
